{% extends "layout-main.html" %}

{% block content %}
	<div class="row">
		<div class="col-lg-12">
			<h2>Applications Dashboard</h2>
			<hr>
		</div>
	</div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Applications
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#discrete" id="tab-discrete-chart" data-toggle="tab">Charts</a>
                        </li>
                        <li><a href="#datatables-table" data-toggle="tab">Table</a>
                        </li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="discrete">
                            <br/>
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Status
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_status"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Platform
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_platform"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       App Type
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_apptype"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                        </div>
                        <div class="tab-pane fade in" id="datatables-table">
                            <h4>Data Tables</h4>
                            <div class="table-responsive">
                                 <table id="table-apps" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                            </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->

{% endblock %}

{% block scripts %}

<script type="text/javascript">

$.getJSON( "/api/get/apps/table", function( data ) {
/* Formatting function for row details - modify as you need */
    function format ( d ) {
        // `d` is the original data object for the row
        return '<table class="table">'+
            '<tr>'+
                '<td>ID:</td>'+
                '<td>'+d.app_id+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Application Type:</td>'+
                '<td>'+d.app_type.desc+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Environment:</td>'+
                '<td>'+d.env+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Version</td>'+
                '<td>'+d.version+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Platform</td>'+
                '<td>'+d.platform+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Contact</td>'+
                '<td>'+d.contact+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Reported to Dpt.</td>'+
                '<td>'+d.reported_to_dpt+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Open Issues</td>'+
                '<td>'+d.open_issues+'</td>'+
            '</tr>'+
        '</table>';
    }

    // Create DataTables
    var table = $('#table-apps').DataTable( {
        "bProcessing": true,
        "aaData": data['data'],
        "aoColumns": [
                {
                "class":          'details-control',
                "orderable":      false,
                "searchable":     true,
                "mDataProp":       null,
                "defaultContent": '<span class="glyphicon glyphicon-th-list"></span>',
                "width":           "20px"
            },
            { "sTitle": "Description",  "mDataProp": "desc" },
            { "sTitle": "AppType",      "mDataProp": "app_type.desc" },
            { "sTitle": "Bundle",       "mDataProp": "bundle[0].name" },
            { "sTitle": "Platform",     "mDataProp": "platform" },
            { "sTitle": "Version",      "mDataProp": "version"},
            { "sTitle": "Status",       "mDataProp": "status" }
        ],
        "drawCallback": function ( settings ) {
            var api = this.api();
            var rows = api.rows( {page:'current'} ).nodes();
            var last=null;
 
            api.column(3, {page:'current'} ).data().each( function ( group, i ) {
                if ( last !== group ) {
                    $(rows).eq( i ).before(
                        '<tr class="table-group"><td style="background-color: #ECECEC; font-weight: bold;" colspan="7">'+group+'</td></tr>'
                    );
 
                    last = group;
                }
            } );
        }
    });

    // Add event listener for opening and closing details
    $('#table-apps tbody').on('click', 'td', function () {
        var tr = $(this).closest('tr');
        console.log(table.row);
        var row = table.row(tr);

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    });


    /** Add charts **/

    function get_status_data(items) {
        // Add status data
        var status = []
        $.each(items, function(i, item) {
            status.push(item.status)
        });

        return count_occurences(status);
    }

    function get_platform_data(items) {
        var platform = []
        $.each(items, function(i, item) {
            platform.push(item.platform)
        });

        return count_occurences(platform);
    }

    function get_apptype_data(items) {
        var apptype = []
        $.each(items, function(i, item) {
            apptype.push(item.app_type.desc)
        });

        return count_occurences(apptype);
    }



    // Add charts
    addDiscreteChart(get_status_data(data['data']), "#discrete_bar_chart_status");
    addDiscreteChart(get_platform_data(data['data']),"#discrete_bar_chart_platform")
    addDiscreteChart(get_apptype_data(data['data']),"#discrete_bar_chart_apptype")
});

</script>
{% endblock %}
