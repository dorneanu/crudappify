{% extends "layout-main.html" %}

{% block content %}
	<div class="row">
		<div class="col-lg-12">
			<h2>Applications Dashboard</h2>
			<hr>
		</div>
	</div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Applications
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#discrete" id="tab-discrete-chart" data-toggle="tab">Charts</a>
                        </li>
                        <li><a href="#datatables-table" id="tab-datatables" data-toggle="tab">Table</a>
                        </li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="discrete">
                            <br/>
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Status
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_status"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Platform
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_platform"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       App Type
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart_apptype"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                        </div>
                        <div class="tab-pane fade in" id="datatables-table">
                            <h4>Data Tables</h4>
                            <div class="panel-group" id="accordion">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">Filters</a>
                                        </h4>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse in">
                                        <div class="panel-body">
                                            <table cellpadding="0" cellspacing="0" border="0" class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Target</th>
                                                        <th>Filter text</th>
                                                        <th>Treat as regex</th>
                                                        <th>Use smart filter</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr id="filter_global">
                                                        <td>Global filtering</td>
                                                        <td><input type="text"     name="global_filter" id="global_filter"></td>
                                                        <td><input type="checkbox" name="global_regex"  id="global_regex" ></td>
                                                        <td><input type="checkbox" name="global_smart"  id="global_smart"  checked></td>
                                                    </tr>
                                                    <tr id="filter_col1">
                                                        <td>Description</td>
                                                        <td><input type="text"     name="col1_filter" id="col1_filter"></td>
                                                        <td><input type="checkbox" name="col1_regex"  id="col1_regex"></td>
                                                        <td><input type="checkbox" name="col1_smart"  id="col1_smart" checked></td>
                                                    </tr>
                                                    <tr id="filter_col2">
                                                        <td>App Type</td>
                                                        <td><input type="text"     name="col2_filter" id="col2_filter"></td>
                                                        <td><input type="checkbox" name="col2_regex"  id="col2_regex"></td>
                                                        <td><input type="checkbox" name="col2_smart"  id="col2_smart" checked></td>
                                                    </tr>
                                                    <tr id="filter_col3">
                                                        <td>Bundle</td>
                                                        <td><input type="text"     name="col3_filter" id="col3_filter"></td>
                                                        <td><input type="checkbox" name="col3_regex"  id="col3_regex"></td>
                                                        <td><input type="checkbox" name="col3_smart"  id="col3_smart" checked></td>
                                                    </tr>
                                                    <tr id="filter_col4">
                                                        <td>Platform</td>
                                                        <td><input type="text"     name="col4_filter" id="col4_filter"></td>
                                                        <td><input type="checkbox" name="col4_regex"  id="col4_regex"></td>
                                                        <td><input type="checkbox" name="col4_smart"  id="col4_smart" checked></td>
                                                    </tr>
                                                    <tr id="filter_col5">
                                                        <td>Version</td>
                                                        <td><input type="text"     name="col5_filter" id="col5_filter"></td>
                                                        <td><input type="checkbox" name="col5_regex"  id="col5_regex"></td>
                                                        <td><input type="checkbox" name="col5_smart"  id="col5_smart" checked></td>
                                                    </tr>
                                                    <tr id="filter_col6">
                                                        <td>Status</td>
                                                        <td><input type="text"     name="col6_filter" id="col6_filter"></td>
                                                        <td><input type="checkbox" name="col6_regex"  id="col6_regex"></td>
                                                        <td><input type="checkbox" name="col6_smart"  id="col6_smart" checked></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                 <table id="table-apps" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                            </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->

{% endblock %}

{% block scripts %}

<script type="text/javascript">

$.getJSON( "/api/get/apps/table", function( data ) {
/* Formatting function for row details - modify as you need */
    function format ( d ) {
        // `d` is the original data object for the row
        return '<table class="table">'+
            '<tr>'+
                '<td>ID:</td>'+
                '<td><a href="/admin/app/edit/?url=/admin/app/&id='+d.app_id+'">'+d.app_id+'</a></td>'+
            '</tr>'+
            '<tr>'+
                '<td>Application Type:</td>'+
                '<td>'+d.app_type.desc+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Environment:</td>'+
                '<td>'+d.env+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Version</td>'+
                '<td>'+d.version+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Platform</td>'+
                '<td>'+d.platform+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Contact</td>'+
                '<td>'+d.contact+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Reported to Dpt.</td>'+
                '<td>'+d.reported_to_dpt+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Open Issues</td>'+
                '<td>'+d.open_issues+'</td>'+
            '</tr>'+
        '</table>';
    }

    // Create DataTables
    var table = $('#table-apps').DataTable( {
        "bProcessing": true,
        "sDom": '<"top">rt<"bottom"flp><"clear">',
        "aaData": data['data'],
        "aoColumns": [
                {
                "class":          'details-control',
                "orderable":      false,
                "searchable":     true,
                "mDataProp":       null,
                "defaultContent": '<span class="glyphicon glyphicon-th-list"></span>',
                "width":           "20px"
            },
            { "type": "text", "sTitle": "Description",  "mDataProp": "desc" },
            { "type": "text", "sTitle": "AppType",      "mDataProp": "app_type.desc" },
            { "type": "text", "sTitle": "Bundle",       "mDataProp": "bundle[0].name" },
            { "type": "text", "sTitle": "Platform",     "mDataProp": "platform" },
            { "type": "text", "sTitle": "Version",      "mDataProp": "version"},
            { "type": "text", "sTitle": "Status",       "mDataProp": "status" }
        ],
        "drawCallback": function ( settings ) {
            var api = this.api();
            var rows = api.rows( {page:'current'} ).nodes();
            var last=null;
 
            api.column(3, {page:'current'} ).data().each( function ( group, i ) {
                if ( last !== group ) {
                    $(rows).eq( i ).before(
                        '<tr class="table-group"><td style="background-color: #ECECEC; font-weight: bold;" colspan="7">'+group+'</td></tr>'
                    );
 
                    last = group;
                }
            } );
        }
    });

    // Add filtering

    // Description
    $("#col1_filter").keyup( function() { fnFilterColumn("#table-apps", 1); } );
    $("#col1_regex").click(  function() { fnFilterColumn("#table-apps", 1 ); } );
    $("#col1_smart").click(  function() { fnFilterColumn("#table-apps", 1 ); } );

    // AppType
    $("#col2_filter").keyup( function() { fnFilterColumn("#table-apps", 2); } );
    $("#col2_regex").click(  function() { fnFilterColumn("#table-apps", 2 ); } );
    $("#col2_smart").click(  function() { fnFilterColumn("#table-apps", 2 ); } );

    // Bundle
    $("#col3_filter").keyup( function() { fnFilterColumn("#table-apps", 3); } );
    $("#col3_regex").click(  function() { fnFilterColumn("#table-apps", 3 ); } );
    $("#col3_smart").click(  function() { fnFilterColumn("#table-apps", 3 ); } );

    // Platform
    $("#col4_filter").keyup( function() { fnFilterColumn("#table-apps", 4); } );
    $("#col4_regex").click(  function() { fnFilterColumn("#table-apps", 4 ); } );
    $("#col4_smart").click(  function() { fnFilterColumn("#table-apps", 4 ); } );

    // Version
    $("#col5_filter").keyup( function() { fnFilterColumn("#table-apps", 5); } );
    $("#col5_regex").click(  function() { fnFilterColumn("#table-apps", 5 ); } );
    $("#col5_smart").click(  function() { fnFilterColumn("#table-apps", 5 ); } );

    // Status
    $("#col6_filter").keyup( function() { fnFilterColumn("#table-apps", 6); } );
    $("#col6_regex").click(  function() { fnFilterColumn("#table-apps", 6 ); } );
    $("#col6_smart").click(  function() { fnFilterColumn("#table-apps", 6 ); } );

    // Add event listener for opening and closing details
    $('#table-apps tbody').on('click', 'td', function () {
        var tr = $(this).closest('tr');
        console.log(table.row);
        var row = table.row(tr);

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    });


    /** Add charts **/

    function get_status_data(items) {
        // Add status data
        var status = []
        $.each(items, function(i, item) {
            status.push(item.status)
        });

        return count_occurences(status);
    }

    function get_platform_data(items) {
        var platform = []
        $.each(items, function(i, item) {
            platform.push(item.platform)
        });

        return count_occurences(platform);
    }

    function get_apptype_data(items) {
        var apptype = []
        $.each(items, function(i, item) {
            apptype.push(item.app_type.desc)
        });

        return count_occurences(apptype);
    }



    // Add charts
    addDiscreteChart(get_status_data(data['data']), "#discrete_bar_chart_status");
    addDiscreteChart(get_platform_data(data['data']),"#discrete_bar_chart_platform")
    addDiscreteChart(get_apptype_data(data['data']),"#discrete_bar_chart_apptype")

    // Add total number of items
    $('#tab-datatables').text("Applications (" + data['data'].length+ ")");
});

</script>
{% endblock %}
