{% extends "layout-main.html" %}

{% block content %}
	<div class="row">
		<div class="col-lg-12">
			<h2>Targets Dashboard</h2>
			<hr>
		</div>
	</div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Charts
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#discrete" id="tab-discrete-chart" data-toggle="tab">Charts</a>
                        </li>
                        <li><a href="#datatables" id="tab-datatables" data-toggle="tab">Targets Table</a>
                        </li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div class="tab-pane fade in active" id="discrete">
                            <br/>
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Discrete Bar Chart
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="discrete_bar_chart"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                            <div class="col-lg-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                       Pie Chart
                                    </div>
                                    <!-- /.panel-heading -->
                                    <div class="panel-body">
                                        <div>
                                            <div id="pie_chart"></div>
                                        </div>
                                    </div>
                                    <!-- /.panel-body -->
                                </div>
                                <!-- /.panel -->
                            </div>
                            <!-- /.col-lg-6 -->
                        </div>
                        <div class="tab-pane fade in" id="datatables">
                            <h4>DataTables</h4>
                            <div>
                                <table id="table-targets" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->

{% endblock %}

{% block scripts %}

<script type="text/javascript">
// Get JSON data
var targets_data = [];
$.getJSON( "/api/get/targets/tags", function( data ) {

	// Add charts
	addDiscreteChart(data['discrete'], "#discrete_bar_chart");
	addPieChart(data['tags'], "#pie_chart");

});


/* Init Bootstrap Tables */
$.getJSON( "/api/get/targets/table", function( data ) {

    function format ( d ) {
        // Add tags
        var tags = [];
        $.each(d.tags, function(i, item) {
            tags.push(item.name);  
        });

        var connection = d.connection;

        // `d` is the original data object for the row
        return '<table class="table">'+
            '<tr>'+
                '<td>ID:</td>'+
                '<td>'+d.id+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Tags:</td>'+
                '<td>'+tags.join(", ")+
                '</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Connection:</td>'+
                 '<td>'+
                    '<table class="table">'+
                        '<tr>'+
                            '<td>ID:</td>'+
                            '<td>'+connection.id+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>Conn Type:</td>'+
                            '<td>'+connection.conn_type+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>URL:</td>'+
                            '<td>'+connection.url+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>Port:</td>'+
                            '<td>'+connection.port+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>Answer:</td>'+
                            '<td>'+connection.answer+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>Redirect:</td>'+
                            '<td>'+connection.redirect+'</td>'+
                        '</tr>'+
                        '<tr>'+
                            '<td>IP(s):</td>'+
                            '<td>'+connection.ip+'</td>'+
                        '</tr>'+
                    '</table>'+
                '</td>'+
            '</tr>'+
        '</table>';
    }
    // Create DataTables
    var table = $('#table-targets').DataTable( {
        "bProcessing": true,
        "aaData": data['data'],
        "aoColumns": [
            {
                "class":          'details-control',
                "orderable":      false,
                "searchable":     true,
                "mDataProp":       null,
                "defaultContent": '<span class="glyphicon glyphicon-th-list"></span>',
                "width":           "20px"
            },
            { "sTitle": "Scheme",   "mDataProp": "scheme" },
            { "sTitle": "Netloc",   "mDataProp": "netloc" },
            { "sTitle": "Port",   "mDataProp": "port" },
            { "sTitle": "Query", "mDataProp": "query"},
            { "sTitle": "Tags",  "mDataProp": "comments" }
        ]
    });

    // Add event listener for opening and closing details
    $('#table-targets tbody').on('click', 'td', function () {
        var tr = $(this).closest('tr');
        console.log(table.row);
        var row = table.row(tr);

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    });
});
</script>
{% endblock %}
